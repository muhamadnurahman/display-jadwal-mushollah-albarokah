<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jadwal Sholat</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      margin: 0;
      padding: 20px;
      color: #fff;
      text-align: center;
    }

    h2 {
      color: #81c784;
      font-size: 2rem;
      margin-bottom: 5px;
    }

    #tanggal {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: #ffeb3b;
    }

    #jadwal-sholat {
      margin-top: 20px;
      background-color: #1c1c1c;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.1);
      padding: 10px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .sholat {
      padding: 10px;
      border-bottom: 1px solid #444;
      font-size: 1.2rem;
      color: #90caf9;
    }

    .sholat:last-child {
      border-bottom: none;
    }

    #next-prayer {
      font-weight: bold;
      margin-top: 25px;
      font-size: 1.3rem;
      color: #ffc107;
      background-color: #333;
      display: inline-block;
      padding: 10px 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(255, 255, 255, 0.15);
    }

    #lokasi-info {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Jadwal Sholat</h2>
  <div id="lokasi-info">Menentukan lokasi...</div>
  <div id="tanggal">Memuat tanggal...</div>
  <div id="jadwal-sholat">Memuat jadwal sholat...</div>
  <div id="next-prayer"></div>

  <script>
    const hijriMonths = [
      "Muharram", "Safar", "Rabiul Awal", "Rabiul Akhir", "Jumadil Awal", "Jumadil Akhir",
      "Rajab", "Sya'ban", "Ramadhan", "Syawal", "Zulkaidah", "Zulhijah"
    ];

    function getHijriDate() {
      const today = new Date();
      const hijri = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {
        day: 'numeric', month: 'numeric', year: 'numeric'
      }).formatToParts(today);

      const hDay = hijri.find(part => part.type === 'day').value;
      const hMonth = hijri.find(part => part.type === 'month').value;
      const hYear = hijri.find(part => part.type === 'year').value;

      return `${hDay} ${hijriMonths[parseInt(hMonth) - 1]} ${hYear} H`;
    }

    function getMasehiDate() {
      const now = new Date();
      const options = { day: 'numeric', month: 'long', year: 'numeric' };
      return now.toLocaleDateString('id-ID', options);
    }

    function tampilkanTanggal() {
      const masehi = getMasehiDate();
      const hijri = getHijriDate();
      document.getElementById("tanggal").textContent = `${masehi} M / ${hijri}`;
    }

    async function getPrayerTimes(lat, lon) {
      const response = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=20`);
      const data = await response.json();
      return { timings: data.data.timings, location: data.data.meta };
    }

    async function tampilkanJadwalSholat(lat = -6.7325, lon = 108.5523) {
      const result = await getPrayerTimes(lat, lon);
      const timings = result.timings;
      const lokasi = result.location;

      document.getElementById("lokasi-info").textContent = `Lokasi saat ini: ${lokasi.timezone}`;

      const prayerMap = {
        Fajr: "Subuh",
        Dhuhr: "Dzuhur",
        Asr: "Ashar",
        Maghrib: "Maghrib",
        Isha: "Isya"
      };

      const jadwal = document.getElementById("jadwal-sholat");
      jadwal.innerHTML = "";

      for (const [key, label] of Object.entries(prayerMap)) {
        const waktu = timings[key];
        const div = document.createElement("div");
        div.className = "sholat";
        div.textContent = `${label}: ${waktu}`;
        jadwal.appendChild(div);
      }

      window.waktuSholat = {
        Subuh: timings.Fajr,
        Dzuhur: timings.Dhuhr,
        Ashar: timings.Asr,
        Maghrib: timings.Maghrib,
        Isya: timings.Isha
      };
    }

    function getNextPrayerTime() {
      const prayerTimes = window.waktuSholat;
      if (!prayerTimes) return { name: "-", date: new Date() };

      const now = new Date();
      const times = Object.entries(prayerTimes).map(([name, time]) => {
        const [hours, minutes] = time.split(":").map(Number);
        const prayerDate = new Date(now);
        prayerDate.setHours(hours, minutes, 0, 0);
        return { name, date: prayerDate };
      });

      for (const { name, date } of times) {
        if (date > now) return { name, date };
      }

      const nextDay = new Date(now);
      nextDay.setDate(now.getDate() + 1);
      const [h, m] = prayerTimes["Subuh"].split(":").map(Number);
      nextDay.setHours(h, m, 0, 0);
      return { name: "Subuh", date: nextDay };
    }

    function updateCountdown() {
      const { name, date } = getNextPrayerTime();
      const now = new Date();
      const diff = Math.max(0, date - now);
      const hours = Math.floor(diff / 1000 / 60 / 60);
      const minutes = Math.floor((diff / 1000 / 60) % 60);
      const seconds = Math.floor((diff / 1000) % 60);

      document.getElementById("next-prayer").textContent =
        `Menuju ${name} berikutnya: ${hours}j ${minutes}m ${seconds}d`;
    }

    function initApp() {
      tampilkanTanggal();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            tampilkanJadwalSholat(lat, lon).then(() => {
              updateCountdown();
              setInterval(updateCountdown, 1000);
            });
          },
          (err) => {
            console.warn("Gagal ambil lokasi, pakai default (Cirebon)");
            tampilkanJadwalSholat().then(() => {
              updateCountdown();
              setInterval(updateCountdown, 1000);
            });
          }
        );
      } else {
        tampilkanJadwalSholat().then(() => {
          updateCountdown();
          setInterval(updateCountdown, 1000);
        });
      }
    }

    initApp();
  </script>
</body>
</html>
